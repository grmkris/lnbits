{% extends "public.html" %} {% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col-12 col-md-7 col-lg-6 q-gutter-y-md">
    {% if tournament_state == 'pending' %}
    <q-card class="q-pa-lg">
      <q-card-section class="q-pa-none">
        <h3 class="q-my-none">{{ tournament_name }} - {{ tournament_state }}</h3>
        <br />
        <div class="q-my-none">
          {{ tournament_description }}
        </div>
        <br />
        <q-form @submit="Invoice()" class="q-gutter-md">
          <q-input filled dense v-model.trim="formDialog.data.email" type="email"
            label="Your email (optional, if you want a reply)"></q-input>
          <q-input filled dense v-model.trim="formDialog.data.challonge_username" type="text"
            label="Your challonge username">
          </q-input>
          <q-input filled dense v-model.trim="formDialog.data.username" type="text" label="Your username">
          </q-input>
          <p>
            Signup fee: {{ tournament_signup_fee }} sats<br />
          </p>
          <div class="row q-mt-lg">
            <q-btn unelevated color="deep-purple" :disable="formDialog.data.username == ''" type="submit">Submit</q-btn>
            <q-btn @click="resetForm" flat color="grey" class="q-ml-auto">Cancel</q-btn>
          </div>
        </q-form>
      </q-card-section>
    </q-card>
    {% endif %}

    {% if tournament_state == 'underway' or tournament_state == 'awaiting_review'%}
    <q-card class="q-pa-lg">
      <q-card-section>
        <h3 class="q-my-none">{{ tournament_name }} - {{ tournament_state }}</h3>
        <p><a href=https://challonge.com/{{tournament_challonge_tournament_id}}>Tournament</a> is underway, check back later</p>
        <iframe src="https://challonge.com/{{tournament_challonge_tournament_id}}/module" width="100%" height="500" frameborder="0" scrolling="auto" allowtransparency="true"></iframe>
      </q-card-section>
    </q-card>
    {% endif %}
  
    {% if tournament_state == 'complete' %}
    <q-card class="q-pa-lg">
      <q-card-section>
        <h3 class="q-my-none">{{ tournament_name }} - {{ tournament_state }}</h3>
        <iframe src="https://challonge.com/{{tournament_challonge_tournament_id}}/module" width="100%" height="500" frameborder="0" scrolling="auto" allowtransparency="true"></iframe>
        <p> <a href=https://challonge.com/{{tournament_challonge_tournament_id}}>Tournament</a> is over, if you are a üèÜ winner üèÜ input your secret that you received when signing up</p>
      </q-card-section>
      <q-form @submit="ClaimWin()" class="q-gutter-md">
        <q-input filled dense v-model.trim="formDialog.data.secret" type="text" label="Your secret">
        </q-input>
        <div class="row q-mt-lg">
          <q-btn unelevated color="deep-purple" :disable="formDialog.data.secret == ''" type="submit">Submit</q-btn>
          <q-btn @click="resetForm" flat color="grey" class="q-ml-auto">Cancel</q-btn>

        </div>
      </q-form>
    </q-card>
    {% endif %}


  </div>

  <q-dialog v-model="receive.show" position="top" @hide="closeReceiveDialog">
    <q-card v-if="!receive.paymentReq" class="q-pa-lg q-pt-xl lnbits__dialog-card">
    </q-card>
    <q-card v-else class="q-pa-lg q-pt-xl lnbits__dialog-card">
      <div class="text-center q-mb-lg">
        <a :href="'lightning:' + receive.paymentReq">
          <q-responsive :ratio="1" class="q-mx-xl">
            <qrcode :value="paymentReq" :options="{width: 340}" class="rounded-borders"></qrcode>
          </q-responsive>
        </a>
      </div>
      <div class="row q-mt-lg">
        <q-btn outline color="grey" @click="copyText(receive.paymentReq)">Copy invoice</q-btn>
        <q-btn v-close-popup flat color="grey" class="q-ml-auto">Close</q-btn>
      </div>
    </q-card>
  </q-dialog>
</div>

{% endblock %} {% block scripts %}
<script>
  console.log('{{ domain_cost }}')
  Vue.component(VueQrcode.name, VueQrcode)

  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        tournament: null,
        paymentReq: null,
        redirectUrl: null,
        formDialog: {
          show: false,
          data: {
            challonge_username: '',
            username: '',
            email: ''
          }
        },
        receive: {
          show: false,
          status: 'pending',
          paymentReq: null
        }
      }
    },
    computed: {
      amountSats() {
        var sats = this.formDialog.data.duration * parseInt('{{ domain_cost }}')
        this.formDialog.data.sats = sats
        return sats
      }
    },

    methods: {
      resetForm: function (e) {
        e.preventDefault()
        this.formDialog.data.challonge_username = ''
        this.formDialog.data.email = ''
        this.formDialog.data.username = ''
      },
      getTournaments: function () {
        var self = this

        LNbits.api
          .request(
            'GET',
            '/challonge/api/v1/tournaments?all_wallets',
            this.g.user.wallets[0].inkey
          )
          .then(function (response) {
            self.tournaments = response.data.map(function (obj) {
              return mapLNTournament(obj)
            })
          })
      },

      closeReceiveDialog: function () {
        var checker = this.receive.paymentChecker
        dismissMsg()

        clearInterval(paymentChecker)
        setTimeout(function () { }, 10000)
      },
      Invoice: function () {
        var self = this
        axios
          .post('/challonge/api/v1/participants/{{ tournament_id }}', {
            tournament: '{{ tournament_id }}',
            email: self.formDialog.data.email,
            challonge_username: self.formDialog.data.challonge_username,
            username: self.formDialog.data.username,
          })
          .then(function (response) {
            self.paymentReq = response.data.payment_request
            self.paymentCheck = response.data.payment_hash

            dismissMsg = self.$q.notify({
              timeout: 0,
              message: 'Waiting for payment...'
            })

            self.receive = {
              show: true,
              status: 'pending',
              paymentReq: self.paymentReq
            }

            paymentChecker = setInterval(function () {
              axios
                .get('/challonge/api/v1/participants/' + self.paymentCheck)
                .then(function (res) {
                  console.log(res.data)
                  if (res.data.paid) {
                    clearInterval(paymentChecker)
                    self.receive = {
                      show: false,
                      status: 'complete',
                      paymentReq: null
                    }
                    dismissMsg()

                    console.log(self.formDialog)
                    self.formDialog.data.email = ''
                    self.formDialog.data.challonge_username = ''
                    self.formDialog.data.username = ''
                    self.$q.notify({
                      type: 'positive',
                      message: 'Sent, thank you!',
                      icon: 'thumb_up'
                    })
                    console.log('END')
                  }
                })
                .catch(function (error) {
                  console.log(error)
                  LNbits.utils.notifyApiError(error)
                })
            }, 2000)
          })
          .catch(function (error) {
            console.log(error)
            LNbits.utils.notifyApiError(error)
          })
      },
      ClaimWin: function () {
        var self = this
        axios
          .post('/challonge/api/v1/participants/{{ tournament_id }}', {
            tournament: '{{ tournament_id }}',
            email: self.formDialog.data.email,
            challonge_username: self.formDialog.data.challonge_username,
            username: self.formDialog.data.username,
          })
          .then(function (response) {
            self.paymentReq = response.data.payment_request
            self.paymentCheck = response.data.payment_hash

            dismissMsg = self.$q.notify({
              timeout: 0,
              message: 'Waiting for payment...'
            })

            self.receive = {
              show: true,
              status: 'pending',
              paymentReq: self.paymentReq
            }

            paymentChecker = setInterval(function () {
              axios
                .get('/challonge/api/v1/participants/' + self.paymentCheck)
                .then(function (res) {
                  console.log(res.data)
                  if (res.data.paid) {
                    clearInterval(paymentChecker)
                    self.receive = {
                      show: false,
                      status: 'complete',
                      paymentReq: null
                    }
                    dismissMsg()

                    console.log(self.formDialog)
                    self.formDialog.data.email = ''
                    self.formDialog.data.challonge_username = ''
                    self.formDialog.data.username = ''
                    self.$q.notify({
                      type: 'positive',
                      message: 'Sent, thank you!',
                      icon: 'thumb_up'
                    })
                    console.log('END')
                  }
                })
                .catch(function (error) {
                  console.log(error)
                  LNbits.utils.notifyApiError(error)
                })
            }, 2000)
          })
          .catch(function (error) {
            console.log(error)
            LNbits.utils.notifyApiError(error)
          })
      }
    }
  })
</script>
{% endblock %}